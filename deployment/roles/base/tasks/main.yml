# Kill any stale apt/dpkg processes left by a previously interrupted deploy.
# These hold locks that cause subsequent apt operations to hang indefinitely.
- name: Kill stale apt-get processes
  ansible.builtin.shell: pkill -9 apt-get || true
  changed_when: false

- name: Kill stale dpkg processes
  ansible.builtin.shell: pkill -9 dpkg || true
  changed_when: false

- name: Reconfigure dpkg in case it was interrupted
  ansible.builtin.command: dpkg --configure -a
  changed_when: false

# The first time the box boots, _something_ needs to run apt-get update
- name: "Accept repository metadata changes"
  ansible.builtin.command: apt-get update --allow-releaseinfo-change
  register: apt_update_result
  changed_when: false
  failed_when: false

- name: "Update Repository cache"
  ansible.builtin.apt:
    update_cache: true
    update_cache_retries: 4
    cache_valid_time: 86400
    force_apt_get: true

- name: Install apt-transport-https
  ansible.builtin.apt:
    name: [
      'apt-transport-https',
    ]
    state: latest

- name: Install base dependencies
  ansible.builtin.apt:
    name: [
      'sudo',
      'python3-pip',
      'net-tools',
    ]
    state: latest

